const { ethers } = require("ethers");
require("dotenv").config();

// SBT contract ABI - copy the important functions only for brevity
const contractABI = [
  "function applyForSBT(bytes32 _voterHash) external",
  "function getApplicationStatus(address applicant) public view returns (bool hasApplied, bool isRegistered)",
  "function isRegisteredVoter(address voter) public view returns (bool)"
];

// Basic SBT token contract implementation
const contractBytecode = "0x608060405234801561001057600080fd5b506040518060400160405280601681526020017f566f7465722053776f756c426f756e6420546f6b656e000000000000000000008152506040518060400160405280600481526020017f5653425400000000000000000000000000000000000000000000000000000000815250816000908051906020019061008c9291906100ad565b508060019080519060200190610103929190610042565b50505061010336600461010a565b610162565b600033905090565b6100d7828261059e565b5050565b6100e3826105e8565b5050565b6100f0828261087a565b5050565b6100fd828261052d565b5050565b6101073382610511565b50565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b600033905090565b6000602082840312156113f7578183fd5b813561140281610738565b9392505050565b600060208284031215611414578283fd5b815161141f81610738565b9392505050565b6000806040838503121561140f578283fd5b600080600080600060a0868803121561140f578283fd5b600080600080600060a0868803121561140f578283fd5b600080600060608486031215611469578283fd5b505081359360208301359350604090920135919050565b6000806040838503121561145d578182fd5b505080516020909101519092909150565b60006114af8261061a565b6114b9818561061f565b93506114c9818560208601610625565b6114d281610738565b9093019392505050565b60006114e88261061a565b6114f2818561061f565b9350614502818560208601610625565b80840191505092915050565b600061151a828461064b565b91508190509392505050565b600061153382856114dd565b915061153f8284611509565b915061154b8284611509565b9150819050949350505050565b600061156482866114dd565b915061157082856114dd565b915061157c8284611509565b9150819050949350505050565b60006115958286611558565b91506115a182856114dd565b91506115ad8284611509565b9150819050949350505050565b60006115c68287611589565b91506115d28286611558565b91506115de8285611509565b91506115ea8284611509565b91508190509695505050505050565b60006020820190506116126000830184611635565b92915050565b600060408201905061162d6000830184611635565b92915050565b61163e816106c5565b82525050565b61163e8161069e565b61163e816106af565b61163e816106b9565b600061166c826106d0565b616765818561061f565b93506167781818560208601610625565b61168181610738565b60001991909101600082019261169857600082019050919050565b92915050565b60006116a8826106d0565b6116b2818561068b565b93506116c2818560208601610625565b6116cb81610738565b9093019392505050565b600061176e826106d0565b6117778185610696565b9350617788818560208601610625565b80840191505092915050565b60006117a082846116dd565b91506117ac8284611509565b915081905092915050565b6000611709826106d0565b61171381846115e5565b9350611723818560208601610625565b80840191505092915050565b600061173a82846116fe565b915061174682846115ba565b91508190509392505050565b61163e816106e1565b61163e8161072d565b6000611772826106d0565b61177c81846115e5565b935061178c818560208601610625565b80840191505092915050565b60006117a382846116fe565b91506117af82846115ba565b91508190509392505050565b6000611897826106d0565b61189081856115e5565b93506118a8818560208601610625565b80840191505092915050565b60006118bf8284611767565b91506118cb8284611797565b91508190509392505050565b600061191b826106d0565b6118ad81856115e5565b9350611901818560208601610625565b80840191505092915050565b600061191882846118b4565b91506119248284611797565b91508190509392505050565b600061193c8283611910565b91506119488283611910565b9150919050565b600061195c828286611930565b9250611968828561172e565b91506119748284611797565b9150819050929550505050565b6000611a3d826106d0565b611a3781856115e5565b9350611a47818560208601610625565b80840191505092915050565b6000611a5e82846116fe565b9150611a6a82846115ba565b91508190509392505050565b6000606082019050611a8c6000830186611635565b611a996020830185611635565b611aa66040830184611635565b949350505050565b6000604082019050611ac3600083018561165c565b611ad06020830184611659565b9392505050565b6000602082019050611aec600083018461166d565b92915050565b60006020820190506000198301600082019261169857600082019050919050565b60006020820190506115d36000830184611635565b60006020820190506000198301600082019261169857600082019050919050565b6000602082019050611b516000830184611635565b92915050565b60006020820190506000198301600082019261169857600082019050919050565b6000602082019050611b8d6000830184611635635b";

async function main() {
  // Replace with your actual values
  const privateKey = process.env.PRIVATE_KEY;
  const sepoliaRpcUrl = process.env.SEPOLIA_RPC_URL;

  if (!privateKey || !sepoliaRpcUrl) {
    console.error("Missing PRIVATE_KEY or SEPOLIA_RPC_URL in .env file");
    process.exit(1);
  }

  console.log("Connecting to Sepolia network...");
  const provider = new ethers.JsonRpcProvider(sepoliaRpcUrl);
  
  // Create a wallet instance
  const wallet = new ethers.Wallet(privateKey, provider);
  console.log("Deploying contract from address:", wallet.address);

  // Check wallet balance
  const balance = await provider.getBalance(wallet.address);
  console.log("Wallet balance:", ethers.formatEther(balance), "ETH");
  
  if (balance < ethers.parseEther("0.01")) {
    console.error("Not enough ETH for deployment! Need at least 0.01 ETH.");
    process.exit(1);
  }

  try {
    // Deploy the contract
    console.log("Deploying SBT contract...");
    
    const factory = new ethers.ContractFactory(
      contractABI,
      contractBytecode,
      wallet
    );
    
    const contract = await factory.deploy();
    console.log("Deployment transaction hash:", contract.deploymentTransaction.hash);
    
    console.log("Waiting for transaction confirmation...");
    await contract.deploymentTransaction.wait();
    
    console.log("SBT Contract deployed to:", await contract.getAddress());
    
    console.log("\n----------------------------------");
    console.log("IMPORTANT: Update your frontend .env file with:");
    console.log(`NEXT_PUBLIC_SBT_CONTRACT=${await contract.getAddress()}`);
    console.log("----------------------------------\n");
    
  } catch (error) {
    console.error("Deployment failed:", error);
    process.exit(1);
  }
}

main()
  .then(() => process.exit(0))
  .catch(error => {
    console.error(error);
    process.exit(1);
  });
